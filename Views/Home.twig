<h1 class="app-main-title">IpInfoTest</h1>
{# Uncomment this to see how translations work: <h1 class="app-main-title">{{ appName }}</h1> #}
<div class="card">
  <div class="card-header">
    <h3 class="card-title">IP Info Test (TechnikNews API)</h3>
  </div>
  <div class="card-body">

    <form id="ipForm" class="row g-3 mb-4">
      <h3 class="card-title">Zadajte IP adresu</h3>
      <div class="col-auto">
        <input type="text" class="form-control" id="ipInput" placeholder="Zadajte IP" value="8.8.8.8">
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-primary">Zistiť info</button>
      </div>
    </form>

    <div id="result"></div>


    <div id="saveMessage" class="mt-2"></div>
    <hr>
    <br>
    <h2 >Obľúbené IP adresy</h2>
    <div class="table-responsive">
      <table class="w-1/2 text-left" >
        <thead>
        <tr>
          <th>IP Adresa</th>
          <th>Krajina</th>
          <th>Mesto</th>
          <th>ISP</th>
          <th>Dátum uloženia</th>
        </tr>
        </thead>
        <tbody>

        {% for item in viewParams.favorites %}
          <tr>
            <td><strong>{{ item.ip }}</strong></td>
            <td>{{ item.country }}</td>
            <td>{{ item.city }}</td>
            <td>{{ item.isp }}</td>
            <td>{{ item.created_at|date("d.m.Y H:i") }}</td>
          </tr>
        {% else %}
          <tr>
            <td colspan="5" class="text-center text-muted">Zatiaľ nie sú žiadne uložené záznamy.</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>

<script>
  let currentData = null;
  document.getElementById('ipForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const ip = document.getElementById('ipInput').value;
    const resultDiv = document.getElementById('result');
    const msgDiv = document.getElementById('saveMessage');
    msgDiv.innerHTML = "";

    try {
      const response = await fetch(`https://api.techniknews.net/ipgeo/${ip}`);
      const data = await response.json();

      if (data.status === "success") {


        currentData = data;


        resultDiv.innerHTML = `
                <h4>Výsledky pre: ${ip}</h4>
                <div class="table-responsive">
                    <table class="table table-bordered text-left w-1/4">
                    <tr><th>Štát</th><td>${data.country} (${data.countryCode})</td></tr>
                    <tr><th>Kraj / Región</th><td>${data.regionName}</td></tr>
                    <tr><th>Mesto</th><td>${data.city}</td></tr>
                    <tr><th>PSČ</th><td>${data.zip}</td></tr>
                    <tr><th>ISP</th><td>${data.isp}</td></tr>
                    <tr><th>Organizácia</th><td>${data.org}</td></tr>
                    <tr><th>Časové pásmo</th><td>${data.timezone}</td></tr>
                    <tr><th>Mena</th><td>${data.currency}</td></tr>
                    </table>
                </div>
                <div class="mt-3">
                    <button id="saveBtn" class="btn btn-success ">
                   Pridať do obľúbených
                    </button>
                </div>
            `;

        document.getElementById('saveBtn').addEventListener('click', saveToFavorites);
      } else {
        resultDiv.innerHTML = `<div class="alert alert-warning">Nepodarilo sa načítať údaje</div>`;
      }
    } catch (err) {
      resultDiv.innerHTML = `<div class="alert alert-danger">Chyba: ${err.message}</div>`;
    }
  });

  async function saveToFavorites() {
    if(!currentData) {
      alert("Chyba: Žiadne dáta na uloženie.");
      return;
    }

    const btn = document.getElementById('saveBtn');
    try {
      const response = await fetch(window.location.href, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
        action: 'save_favorite',
        ip: currentData.ip,
        country: currentData.country,
        city: currentData.city,
        isp: currentData.isp
        })
      });

      const result = await response.json();

      if(result.success) {
        document.getElementById('saveMessage').innerHTML = '<div class="alert alert-success">Uložené, Obnovte stránku pre zobrazenie v zozname</div>';
      } else {
        alert("Chyba pri ukladaní");
      }
    } catch (e) {
      console.error(e);
      alert("Chyba komunikácie");
    }
  }
</script>


{# DO NOT DELETE FOLLOWING LINE, OR `php hubleto` WILL NOT GENERATE CODE HERE #}
{# @hubleto-cli:buttons #}

{#
<div class="grid md:grid-cols-2 gap-2">
  <div class="card">
    <div class="card-header">
      IpInfoTest
    </div>
    <div class="card-body">
      Current date and time is <b>{{ viewParams.now }}</b>.<br/>
      <br/>
      <div class="mt-2">
        <a class="btn btn-primary" href="ipinfotest/contacts">
          <span class="icon"><i class="fas fa-user"></i></span>
          <span class="text">{{ translate("Go to contacts") }}</span>
        </a>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="card-header">
      App info
    </div>
    <div class="card-body">
      This app was generated by <code class="bg-gray-100 p-1 font-bold">php hubleto app create Hubleto\App\Custom\IpInfoTest</code> command on 2025-12-10 22:40:46.<br/>
      <br/>
      <div class="alert alert-info">
        Visit <a href="https://developer.hubleto.com" target="_blank">https://developer.hubleto.com</a> to learn how to develop your custom apps.
      </div>
    </div>
  </div>
</div>
#}